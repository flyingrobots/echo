#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
set -euo pipefail

# 1) PRNG coupling guard (existing logic)
PRNG_FILE="crates/rmg-core/src/math/prng.rs"
if git diff --cached --name-only | grep -qx "$PRNG_FILE"; then
  DIFF=$(git diff --cached -- "$PRNG_FILE" || true)
  if echo "$DIFF" | grep -E '^(\+|-)\s*(fn\s+next_u64|fn\s+from_seed_u64|fn\s+from_seed\(|fn\s+next_int\()' >/dev/null; then
    ALGO_CHANGED=1
  else
    ALGO_CHANGED=0
  fi
  if echo "$DIFF" | grep -E 'PRNG_ALGO_VERSION' >/dev/null; then
    VERSION_CHANGED=1
  else
    VERSION_CHANGED=0
  fi
  if echo "$DIFF" | grep -E 'next_int_golden_regression|assert_eq!\(values,\s*vec!\[' >/dev/null; then
    GOLDEN_CHANGED=1
  else
    GOLDEN_CHANGED=0
  fi
  FAIL=0
  if [[ "$ALGO_CHANGED" -eq 1 && "$VERSION_CHANGED" -eq 0 ]]; then
    echo "pre-commit: PRNG algorithm changed but PRNG_ALGO_VERSION was not bumped." >&2
    FAIL=1
  fi
  if [[ "$VERSION_CHANGED" -eq 1 && "$GOLDEN_CHANGED" -eq 0 ]]; then
    echo "pre-commit: PRNG_ALGO_VERSION bumped but golden regression vector was not updated." >&2
    FAIL=1
  fi
  if [[ "$FAIL" -eq 1 ]]; then
    echo "pre-commit: Refusing commit. Update algorithm version and golden regression together." >&2
    exit 1
  fi
fi

# 2) Enforce toolchain pin (matches rust-toolchain.toml)
if command -v rustup >/dev/null 2>&1; then
  PINNED=$(awk -F '"' '/^channel/ {print $2}' rust-toolchain.toml 2>/dev/null || echo "")
  ACTIVE=$(rustup show active-toolchain 2>/dev/null | awk '{print $1}')
  if [[ -n "$PINNED" && "$ACTIVE" != "$PINNED"* ]]; then
    echo "pre-commit: Active toolchain '$ACTIVE' != pinned '$PINNED'. Run: rustup override set $PINNED" >&2
    exit 1
  fi
fi

# 3) Format (auto-fix if opted in)
_auto_fmt="${ECHO_AUTO_FMT:-1}"
case "${_auto_fmt}" in
  1|true|TRUE|yes|YES|on|ON)
    echo "pre-commit: ECHO_AUTO_FMT=${_auto_fmt} → checking format"
    if ! cargo fmt --all -- --check; then
      echo "pre-commit: running cargo fmt to apply changes" >&2
      cargo fmt --all || { echo "pre-commit: cargo fmt failed" >&2; exit 1; }
      echo "pre-commit: rustfmt updated files. Aborting commit to preserve index integrity (partial staging safe)." >&2
      echo "Hint: review changes, restage (e.g., 'git add -p' or 'git add -A'), then commit again." >&2
      exit 1
    fi
    ;;
  0|false|FALSE|no|NO|off|OFF)
    cargo fmt --all -- --check || { echo "pre-commit: cargo fmt check failed" >&2; exit 1; }
    ;;
  *)
    # Unknown value → safest is check-only
    cargo fmt --all -- --check || { echo "pre-commit: cargo fmt check failed" >&2; exit 1; }
    ;;
esac

# 4) Docs guard: require docs updates on any Rust changes
STAGED=$(git diff --cached --name-only)
RUST_CHANGED=$(echo "$STAGED" | grep -E '\\.rs$' || true)
if [[ -n "$RUST_CHANGED" ]]; then
  echo "$STAGED" | grep -Fx 'docs/execution-plan.md' >/dev/null || { echo 'pre-commit: docs/execution-plan.md must be updated when Rust files change.' >&2; exit 1; }
  echo "$STAGED" | grep -Fx 'docs/decision-log.md' >/dev/null || { echo 'pre-commit: docs/decision-log.md must be updated when Rust files change.' >&2; exit 1; }
fi

# 5) Lockfile guard: ensure lockfile version is v3 (current cargo format)
if [[ -f Cargo.lock ]]; then
  # Normalize detected lockfile version (strip quotes/CR/whitespace)
  VER_LINE=$(grep -n '^version = ' Cargo.lock | head -n1 | awk -F'= ' '{print $2}' | tr -d '\r' | tr -d '"' | xargs)
  if [[ "$VER_LINE" != "3" ]]; then
    # Determine pinned toolchain (normalize), fallback to rust-toolchain.toml if unset
    _PINNED_RAW="${PINNED:-}"
    if [[ -z "$_PINNED_RAW" ]]; then
      _PINNED_RAW=$(awk -F '"' '/^channel/ {print $2}' rust-toolchain.toml 2>/dev/null || echo "")
    fi
    PINNED_NORM=$(printf "%s" "$_PINNED_RAW" | tr -d '\r' | xargs)
    echo "pre-commit: Cargo.lock must be lockfile format v3 (found '$VER_LINE')." >&2
    echo "Run: cargo +${PINNED_NORM} generate-lockfile" >&2
    exit 1
  fi
fi

# 6) Targeted clippy + check for changed crates (fast-ish)
CRATES=$(echo "$STAGED" | sed -n 's#^crates/\([^/]*\)/.*#\1#p' | sort -u)
for c in $CRATES; do
  cargo clippy -p "$c" --all-targets -- -D warnings -D missing_docs
  cargo check -p "$c" --quiet
done

# 7) Docs rollup: regenerate echo-total.md when any docs/**/*.md changed
DOCS_CHANGED=$(echo "$STAGED" | grep -E '^docs/.*\.md$' || true)
if [[ -n "$DOCS_CHANGED" ]]; then
  # Exclude the rollup itself from the trigger set
  TRIGGER=$(echo "$DOCS_CHANGED" | grep -v '^docs/echo-total.md$' || true)
  if [[ -n "$TRIGGER" ]]; then
    if [[ ! -x scripts/gen-echo-total.sh ]]; then
      echo "pre-commit: scripts/gen-echo-total.sh not found or not executable" >&2
      exit 1
    fi
    echo "pre-commit: regenerating docs/echo-total.md due to Markdown changes"
    if ! ./scripts/gen-echo-total.sh; then
      echo "pre-commit: rollup generation failed" >&2
      exit 1
    fi
    # If rollup changed, abort to preserve index and ask author to review + stage
    if ! git diff --quiet -- docs/echo-total.md; then
      echo "pre-commit: docs/echo-total.md updated. Aborting commit to preserve index." >&2
      echo "Hint: review changes, then 'git add docs/echo-total.md' and commit again (or run 'make echo-total')." >&2
      exit 1
    fi
  fi
fi

# 8) SPDX header enforcement (code = Apache-2.0; docs/math = Apache-2.0 OR MIND-UCAL-1.0)
if [[ -x scripts/ensure_spdx.sh ]]; then
  scripts/ensure_spdx.sh || exit 1
fi

exit 0
