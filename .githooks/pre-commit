#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
set -euo pipefail

# 0) Sweep stale build artifacts on odd hours (keeps target/ from ballooning)
#    Manual: ./scripts/sweep-stale-artifacts.sh [days]
HOUR=$(date +%H)
if (( 10#$HOUR % 2 == 1 )) && [[ -x scripts/sweep-stale-artifacts.sh ]]; then
  scripts/sweep-stale-artifacts.sh 14
fi

# Get staged files once for reuse throughout the hook
STAGED=$(git diff --cached --name-only)

# 1) PRNG coupling guard (existing logic)
PRNG_FILE="crates/warp-core/src/math/prng.rs"
if echo "$STAGED" | grep -qx "$PRNG_FILE"; then
  DIFF=$(git diff --cached -- "$PRNG_FILE" || true)
  if echo "$DIFF" | grep -E '^(\+|-)\s*(fn\s+next_u64|fn\s+from_seed_u64|fn\s+from_seed\(|fn\s+next_int\()' >/dev/null; then
    ALGO_CHANGED=1
  else
    ALGO_CHANGED=0
  fi
  if echo "$DIFF" | grep -E 'PRNG_ALGO_VERSION' >/dev/null; then
    VERSION_CHANGED=1
  else
    VERSION_CHANGED=0
  fi
  if echo "$DIFF" | grep -E 'next_int_golden_regression|assert_eq!\(values,\s*vec!\[' >/dev/null; then
    GOLDEN_CHANGED=1
  else
    GOLDEN_CHANGED=0
  fi
  FAIL=0
  if [[ "$ALGO_CHANGED" -eq 1 && "$VERSION_CHANGED" -eq 0 ]]; then
    echo "pre-commit: PRNG algorithm changed but PRNG_ALGO_VERSION was not bumped." >&2
    FAIL=1
  fi
  if [[ "$VERSION_CHANGED" -eq 1 && "$GOLDEN_CHANGED" -eq 0 ]]; then
    echo "pre-commit: PRNG_ALGO_VERSION bumped but golden regression vector was not updated." >&2
    FAIL=1
  fi
  if [[ "$FAIL" -eq 1 ]]; then
    echo "pre-commit: Refusing commit. Update algorithm version and golden regression together." >&2
    exit 1
  fi
fi

# 2) Enforce toolchain pin (matches rust-toolchain.toml)
if command -v rustup >/dev/null 2>&1; then
  PINNED=$(awk -F '"' '/^channel/ {print $2}' rust-toolchain.toml 2>/dev/null || echo "")
  ACTIVE=$(rustup show active-toolchain 2>/dev/null | awk '{print $1}')
  if [[ -n "$PINNED" && "$ACTIVE" != "$PINNED"* ]]; then
    echo "pre-commit: Active toolchain '$ACTIVE' != pinned '$PINNED'. Run: rustup override set $PINNED" >&2
    exit 1
  fi
fi

# 3) Format (auto-fix if opted in)
_auto_fmt="${ECHO_AUTO_FMT:-1}"
case "${_auto_fmt}" in
  1|true|TRUE|yes|YES|on|ON)
    echo "pre-commit: ECHO_AUTO_FMT=${_auto_fmt} → checking format"
    if ! cargo fmt --all -- --check; then
      echo "pre-commit: running cargo fmt to apply changes" >&2
      cargo fmt --all || { echo "pre-commit: cargo fmt failed" >&2; exit 1; }
      echo "pre-commit: rustfmt updated files. Aborting commit to preserve index integrity (partial staging safe)." >&2
      echo "Hint: review changes, restage (e.g., 'git add -p' or 'git add -A'), then commit again." >&2
      exit 1
    fi
    ;;
  0|false|FALSE|no|NO|off|OFF)
    cargo fmt --all -- --check || { echo "pre-commit: cargo fmt check failed" >&2; exit 1; }
    ;;
  *)
    # Unknown value → safest is check-only
    cargo fmt --all -- --check || { echo "pre-commit: cargo fmt check failed" >&2; exit 1; }
    ;;
esac

# 4) Task list guard: prevent contradictory duplicated checklist items
if [[ -f scripts/check_task_lists.sh ]]; then
  if [[ ! -x scripts/check_task_lists.sh ]]; then
    echo "pre-commit: scripts/check_task_lists.sh exists but is not executable. Run: chmod +x scripts/check_task_lists.sh" >&2
    exit 1
  fi
  if echo "$STAGED" | grep -E '^(WASM-TASKS\.md|docs/tasks\.md)$' >/dev/null; then
    scripts/check_task_lists.sh || { echo 'pre-commit: task list conflicts detected.' >&2; exit 1; }
  fi
fi

# 5) Verify Wesley-generated outputs are up to date
echo "Checking Wesley artifacts..."
cargo xtask wesley check || {
    echo "ERROR: Wesley artifacts are stale. Run 'cargo xtask wesley sync' to update."
    exit 1
}

# 6) Lockfile guard: ensure lockfile version matches the pinned Cargo format
if [[ -f Cargo.lock ]]; then
  # Normalize detected lockfile version (strip quotes/CR/whitespace)
  VER_LINE=$(grep -n '^version = ' Cargo.lock | head -n1 | awk -F'= ' '{print $2}' | tr -d '\r' | tr -d '"' | xargs)
  # Cargo 1.90.0 emits lockfile format v4.
  if [[ "$VER_LINE" != "4" ]]; then
    # Determine pinned toolchain (normalize), fallback to rust-toolchain.toml if unset
    _PINNED_RAW="${PINNED:-}"
    if [[ -z "$_PINNED_RAW" ]]; then
      _PINNED_RAW=$(awk -F '"' '/^channel/ {print $2}' rust-toolchain.toml 2>/dev/null || echo "")
    fi
    PINNED_NORM=$(printf "%s" "$_PINNED_RAW" | tr -d '\r' | xargs)
    echo "pre-commit: Cargo.lock must be lockfile format v4 (found '$VER_LINE')." >&2
    echo "Run: cargo +${PINNED_NORM} generate-lockfile" >&2
    exit 1
  fi
fi

# 7) Targeted clippy + check for changed crates (fast-ish)
CRATES=$(echo "$STAGED" | sed -n 's#^crates/\([^/]*\)/.*#\1#p' | sort -u)
for c in $CRATES; do
  if [[ -f "crates/${c}/Cargo.toml" ]]; then
    cargo clippy -p "$c" --all-targets -- -D warnings -D missing_docs
    cargo check -p "$c" --quiet
  fi
done

# 8) SPDX header enforcement (code = Apache-2.0; docs/math = Apache-2.0 OR MIND-UCAL-1.0)
if [[ -x scripts/ensure_spdx.sh ]]; then
  scripts/ensure_spdx.sh || exit 1
fi

# 9) Markdown formatting and linting for staged .md files
# Use -z and --diff-filter=ACMRT to exclude deletions and handle whitespace safely
mapfile -d '' MD_FILES < <(git diff --cached --name-only -z --diff-filter=ACMRT -- '*.md')
if [[ ${#MD_FILES[@]} -gt 0 ]] && command -v npx >/dev/null 2>&1; then
  echo "pre-commit: linting markdown files"

  # Auto-format with prettier if ECHO_AUTO_FMT is enabled (handles tables, etc.)
  case "${_auto_fmt}" in
    1|true|TRUE|yes|YES|on|ON)
      # Check formatting; suppress stdout (file list) but preserve stderr for errors
      if npx prettier --check "${MD_FILES[@]}" >/dev/null; then
        : # Already formatted
      else
        echo "pre-commit: running prettier on markdown files" >&2
        # Write changes; suppress stdout but preserve stderr for errors
        if ! npx prettier --write "${MD_FILES[@]}" >/dev/null; then
          echo "pre-commit: prettier failed" >&2
          exit 1
        fi
        echo "pre-commit: prettier updated markdown files. Aborting commit to preserve index integrity." >&2
        echo "Hint: review changes, restage (e.g., 'git add -p' or 'git add -A'), then commit again." >&2
        exit 1
      fi
      ;;
  esac

  if ! npx markdownlint-cli2 "${MD_FILES[@]}"; then
    echo "pre-commit: markdown lint failed. Run: npx markdownlint-cli2 --fix <files>" >&2
    exit 1
  fi
fi

exit 0
