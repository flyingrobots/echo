#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
# Â© James Ross Î© FLYINGâ€¢ROBOTS <https://github.com/flyingrobots>
# Round-robin pre-push: alternates between sequential/parallel, logs timing
set -euo pipefail

LOGFILE="${PREPUSH_LOGFILE:-.githooks/timing.jsonl}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine which variant to run (round-robin based on line count)
if [[ -f "$LOGFILE" ]]; then
  COUNT=$(wc -l < "$LOGFILE" | tr -d ' ')
else
  COUNT=0
fi

if (( COUNT % 2 == 0 )); then
  VARIANT="sequential"
  SCRIPT="$SCRIPT_DIR/pre-push-sequential"
else
  VARIANT="parallel"
  SCRIPT="$SCRIPT_DIR/pre-push-parallel"
fi

echo "ðŸ“Š pre-push benchmark: running $VARIANT (#$((COUNT + 1)))"

# Time the run
START=$(date +%s.%N)
"$SCRIPT"
RC=$?
END=$(date +%s.%N)

# Calculate duration
DURATION=$(echo "$END - $START" | bc)

# Log result
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
echo "{\"ts\":\"$TIMESTAMP\",\"variant\":\"$VARIANT\",\"duration\":$DURATION,\"exit\":$RC}" >> "$LOGFILE"

echo "ðŸ“Š $VARIANT completed in ${DURATION}s (logged to $LOGFILE)"

exit $RC
