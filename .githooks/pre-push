#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
# Â© James Ross Î© FLYINGâ€¢ROBOTS <https://github.com/flyingrobots>
# Round-robin pre-push: alternates between sequential/parallel, logs timing
set -euo pipefail

LOGFILE="${PREPUSH_LOGFILE:-.githooks/timing.jsonl}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine which variant to run (round-robin based on line count)
if [[ -f "$LOGFILE" ]]; then
  COUNT=$(wc -l < "$LOGFILE" | tr -d ' ')
else
  COUNT=0
fi

if (( COUNT % 2 == 0 )); then
  VARIANT="sequential"
  SCRIPT="$SCRIPT_DIR/pre-push-sequential"
else
  VARIANT="parallel"
  SCRIPT="$SCRIPT_DIR/pre-push-parallel"
fi

echo "ðŸ“Š pre-push benchmark: running $VARIANT (#$((COUNT + 1)))"

# Capture output to check if compilation happened
OUTFILE=$(mktemp)
trap 'rm -f "$OUTFILE"' EXIT

# Time the run, tee output to both terminal and file
START=$(date +%s.%N)
"$SCRIPT" 2>&1 | tee "$OUTFILE"
RC=${PIPESTATUS[0]}
END=$(date +%s.%N)

# Only log timing if cargo actually compiled something
if grep -q "Compiling" "$OUTFILE"; then
  DURATION=$(echo "$END - $START" | bc)
  TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
  echo "{\"ts\":\"$TIMESTAMP\",\"variant\":\"$VARIANT\",\"duration\":$DURATION,\"exit\":$RC}" >> "$LOGFILE"
  echo "ðŸ“Š $VARIANT completed in ${DURATION}s (logged)"
else
  echo "ðŸ“Š $VARIANT completed (no compilation, timing not logged)"
fi

exit $RC
