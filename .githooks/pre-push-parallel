#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
# Parallel pre-push hook - runs stages concurrently with isolated target dirs
set -uo pipefail

PINNED_FROM_FILE=$(awk -F '"' '/^channel/ {print $2}' rust-toolchain.toml 2>/dev/null || echo "")
PINNED="${PINNED:-${PINNED_FROM_FILE:-1.90.0}}"

for cmd in cargo rustup rg; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "[pre-push] missing dependency: $cmd" >&2
    exit 1
  fi
done

echo "ðŸ° BunBun ðŸ‡ (parallel mode)"

LOGDIR=$(mktemp -d)
trap 'rm -rf "$LOGDIR"' EXIT

# Stage functions - each uses its own target dir
run_fmt() {
  CARGO_TARGET_DIR=target-fmt cargo fmt --all -- --check 2>&1
}

run_clippy() {
  CARGO_TARGET_DIR=target-clippy cargo clippy --all-targets -- -D warnings -D missing_docs 2>&1
}

run_tests() {
  CARGO_TARGET_DIR=target-test cargo test --workspace 2>&1
}

run_rustdoc() {
  local out=""
  for krate in warp-core warp-geom warp-ffi warp-wasm; do
    if [ -f "crates/${krate}/Cargo.toml" ]; then
      out+="[rustdoc] ${krate}"$'\n'
      out+=$(CARGO_TARGET_DIR=target-doc RUSTDOCFLAGS="-D warnings" cargo +"$PINNED" doc -p "${krate}" --no-deps 2>&1)$'\n'
    fi
  done
  echo "$out"
}

run_patterns() {
  local failed=0
  if rg -n '#!\[allow\([^]]*missing_docs[^]]*\)\]' crates \
    --glob 'crates/**/src/**/*.rs' \
    --glob '!**/telemetry.rs' \
    --glob '!**/tests/**' \
    --glob '!**/build.rs' \
    --glob '!**/*.generated.rs' >/dev/null 2>&1; then
    echo "FAIL: crate-level allow(missing_docs) is forbidden" >&2
    failed=1
  fi
  if rg -n "\\#\[unsafe\(no_mangle\)\]" crates >/dev/null 2>&1; then
    echo "FAIL: #[unsafe(no_mangle)] is invalid" >&2
    failed=1
  fi
  if [[ -x scripts/check_spdx.sh ]]; then
    scripts/check_spdx.sh 2>&1 || failed=1
  fi
  return $failed
}

# Run stages in parallel
echo "[parallel] launching: fmt, clippy, tests, rustdoc, patterns"
START=$(date +%s)

run_fmt      > "$LOGDIR/fmt.log"      2>&1 & PID_FMT=$!
run_clippy   > "$LOGDIR/clippy.log"   2>&1 & PID_CLIPPY=$!
run_tests    > "$LOGDIR/tests.log"    2>&1 & PID_TESTS=$!
run_rustdoc  > "$LOGDIR/rustdoc.log"  2>&1 & PID_RUSTDOC=$!
run_patterns > "$LOGDIR/patterns.log" 2>&1 & PID_PATTERNS=$!

# Wait and collect results
FAILED=0

wait $PID_FMT;      FMT_RC=$?;      [ $FMT_RC -ne 0 ]      && FAILED=1 && echo "[FAIL] fmt (see log)"
wait $PID_CLIPPY;   CLIPPY_RC=$?;   [ $CLIPPY_RC -ne 0 ]   && FAILED=1 && echo "[FAIL] clippy (see log)"
wait $PID_TESTS;    TESTS_RC=$?;    [ $TESTS_RC -ne 0 ]    && FAILED=1 && echo "[FAIL] tests (see log)"
wait $PID_RUSTDOC;  RUSTDOC_RC=$?;  [ $RUSTDOC_RC -ne 0 ]  && FAILED=1 && echo "[FAIL] rustdoc (see log)"
wait $PID_PATTERNS; PATTERNS_RC=$?; [ $PATTERNS_RC -ne 0 ] && FAILED=1 && echo "[FAIL] patterns (see log)"

END=$(date +%s)
echo "[parallel] completed in $((END - START))s"

if [ $FAILED -ne 0 ]; then
  echo ""
  echo "=== FAILURES ==="
  [ $FMT_RC -ne 0 ]      && echo "--- fmt ---"      && cat "$LOGDIR/fmt.log"
  [ $CLIPPY_RC -ne 0 ]   && echo "--- clippy ---"   && cat "$LOGDIR/clippy.log"
  [ $TESTS_RC -ne 0 ]    && echo "--- tests ---"    && cat "$LOGDIR/tests.log"
  [ $RUSTDOC_RC -ne 0 ]  && echo "--- rustdoc ---"  && cat "$LOGDIR/rustdoc.log"
  [ $PATTERNS_RC -ne 0 ] && echo "--- patterns ---" && cat "$LOGDIR/patterns.log"
  exit 1
fi

echo "[parallel] all checks passed"
exit 0
