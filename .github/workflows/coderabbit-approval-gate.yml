# SPDX-License-Identifier: Apache-2.0
# © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots>
name: PR Merge Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  contents: read
  pull-requests: read

jobs:
  approval-gate:
    name: CodeRabbit approval required
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Require CodeRabbit approval on PR head
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        env:
          CODERABBIT_BOT_LOGINS: ${{ vars.CODERABBIT_BOT_LOGINS || 'coderabbitai[bot]' }}
        with:
          script: |
            if (!context.payload.pull_request) {
              core.setFailed(
                'Workflow triggered without a pull_request object. ' +
                  'This indicates a misconfiguration in event triggers.'
              )
              return
            }

            const owner = context.repo.owner
            const repo = context.repo.repo
            const pull_number = context.payload.pull_request.number
            const headSha = context.payload.pull_request.head.sha

            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            })

            const botLogins = (process.env.CODERABBIT_BOT_LOGINS || 'coderabbitai[bot]')
              .split(',')
              .map((s) => s.trim())
              .filter((s) => s.length > 0)

            const botReviews = reviews.filter((r) => botLogins.includes(r.user?.login))

            if (botReviews.length === 0) {
              core.setFailed(
                `No CodeRabbit approval found (bot logins: ${botLogins.join(', ')}). ` +
                  `Comment "@coderabbitai review" on the PR and wait for an approval.`
              )
              return
            }

            botReviews.sort((a, b) => {
              const aTime = new Date(a.submitted_at).getTime()
              const bTime = new Date(b.submitted_at).getTime()
              return aTime - bTime
            })
            const latest = botReviews[botReviews.length - 1]
            const state = latest.state

            if (state !== 'APPROVED') {
              core.setFailed(
                `${latest.user?.login} review state is ${state}; merge is blocked until it is APPROVED.`
              )
              return
            }

            if (latest.commit_id !== headSha) {
              core.setFailed(
                `${latest.user?.login} approved commit ${latest.commit_id}, but PR head is now ${headSha}. ` +
                  `To proceed:\n` +
                  `1. Comment "@coderabbitai review" on the PR to request re-approval, OR\n` +
                  `2. Wait for the bot to automatically review new commits (if configured), OR\n` +
                  `3. Re-run this workflow after the bot approves the new head commit (Actions tab).`
              )
              return
            }

            core.info(`${latest.user?.login} approved the PR head commit (${headSha}).`)
