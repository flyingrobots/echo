<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Echo — Session Dashboard</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #111822;
        --panel-2: #0e1620;
        --text: #e6edf3;
        --muted: #9fb1c1;
        --accent-a: #7aa2f7;
        --accent-b: #9ece6a;
        --grid: #213041;
        --warn: #f78c6c;
        --ok: #9ece6a;
        --bad: #f7768e;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 24px;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      header {
        max-width: 1100px;
        margin: 0 auto 16px auto;
      }
      header h1 {
        margin: 0 0 8px 0;
        font-size: 22px;
      }
      header p {
        margin: 4px 0;
        color: var(--muted);
      }
      code {
        background: var(--panel-2);
        padding: 2px 6px;
        border-radius: 4px;
      }
      a {
        color: var(--accent-a);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .row {
        max-width: 1100px;
        margin: 0 auto;
      }
      .panel {
        background: var(--panel);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }
      .card {
        background: var(--panel-2);
        border-radius: 10px;
        padding: 14px;
        border-left: 4px solid var(--accent-a);
      }
      .card h3 {
        margin: 0 0 10px 0;
        font-size: 13px;
        font-weight: 700;
        color: var(--muted);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .metric {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 13px;
        padding: 3px 0;
      }
      .metric .label {
        color: var(--muted);
      }
      .metric .value {
        font-variant-numeric: tabular-nums;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        line-height: 18px;
        background: #152233;
        color: var(--muted);
      }
      .pill.ok {
        background: rgba(158, 206, 106, 0.15);
        color: var(--ok);
      }
      .pill.bad {
        background: rgba(247, 118, 142, 0.15);
        color: var(--bad);
      }
      #chart {
        height: 220px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      th,
      td {
        text-align: left;
        padding: 6px 10px;
        border-bottom: 1px solid #1f2a36;
        font-size: 13px;
        font-variant-numeric: tabular-nums;
        vertical-align: top;
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      .mono {
        font-family:
          ui-monospace,
          SFMono-Regular,
          Menlo,
          Monaco,
          Consolas,
          "Liberation Mono",
          "Courier New",
          monospace;
      }
      .warn {
        color: var(--warn);
      }
      .footer {
        color: var(--muted);
        font-size: 12px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header class="row">
      <h1>Echo — Session Dashboard</h1>
      <p>
        Live metrics from <code>echo-session-ws-gateway</code>. This is a lightweight “is the WVP
        pipeline alive?” view: frames, bytes, connections, and per-<code>warp_id</code> epoch
        progress.
      </p>
      <p class="footer">
        Tip: run the full demo from <code>docs/guide/wvp-demo.md</code>, but with a browser client
        routed through this gateway.
      </p>
    </header>

    <main class="row">
      <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px">
          <div>
            <span class="pill mono" id="status-pill">connecting…</span>
            <span class="pill mono" id="uptime-pill">uptime: —</span>
          </div>
          <div class="footer mono">/api/metrics</div>
        </div>

        <div class="grid" style="margin-top: 12px">
          <div class="card">
            <h3>Connections</h3>
            <div class="metric"><span class="label">active</span><span class="value mono" id="m-active">—</span></div>
            <div class="metric"><span class="label">total</span><span class="value mono" id="m-total">—</span></div>
          </div>
          <div class="card">
            <h3>Frames</h3>
            <div class="metric"><span class="label">ws→uds</span><span class="value mono" id="m-ws-frames">—</span></div>
            <div class="metric"><span class="label">uds→ws</span><span class="value mono" id="m-uds-frames">—</span></div>
            <div class="metric"><span class="label">invalid ws</span><span class="value mono warn" id="m-invalid">—</span></div>
          </div>
          <div class="card">
            <h3>Bytes</h3>
            <div class="metric"><span class="label">ws→uds</span><span class="value mono" id="m-ws-bytes">—</span></div>
            <div class="metric"><span class="label">uds→ws</span><span class="value mono" id="m-uds-bytes">—</span></div>
            <div class="metric"><span class="label">decode errs</span><span class="value mono warn" id="m-decode">—</span></div>
          </div>
        </div>

        <div class="panel" style="margin-top: 12px">
          <div style="display: flex; justify-content: space-between; align-items: center">
            <div class="footer">Frames/sec (computed client-side from counter deltas)</div>
            <div class="footer mono" id="m-last-update">last update: —</div>
          </div>
          <div id="chart"></div>
        </div>

        <div class="panel" style="margin-top: 12px">
          <div style="display: flex; justify-content: space-between; align-items: baseline">
            <h2 style="margin: 0; font-size: 16px">WARP Streams</h2>
            <div class="footer">
              Columns are derived from observed protocol messages. For authoritative hub policy,
              add a hub-native metrics endpoint later.
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>warp_id</th>
                <th>subs</th>
                <th>pubs</th>
                <th>last</th>
                <th>epoch</th>
                <th>ts</th>
                <th>state_hash</th>
                <th>snap</th>
                <th>diff</th>
              </tr>
            </thead>
            <tbody id="warp-rows"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      function fmtBytes(n) {
        const units = ["B", "KiB", "MiB", "GiB"];
        let v = n;
        let i = 0;
        while (v >= 1024 && i < units.length - 1) {
          v /= 1024;
          i++;
        }
        return `${v.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      const history = [];
      const maxPoints = 90;
      let lastSample = null;

      async function fetchMetrics() {
        const res = await fetch("/api/metrics", { cache: "no-store" });
        if (!res.ok) throw new Error(`metrics HTTP ${res.status}`);
        return await res.json();
      }

      function updateHeader(m) {
        setText("m-active", String(m.active_connections));
        setText("m-total", String(m.total_connections));

        setText("m-ws-frames", String(m.ws_to_uds.frames));
        setText("m-uds-frames", String(m.uds_to_ws.frames));
        setText("m-invalid", String(m.invalid_ws_frames));

        setText("m-ws-bytes", fmtBytes(m.ws_to_uds.bytes));
        setText("m-uds-bytes", fmtBytes(m.uds_to_ws.bytes));
        setText("m-decode", String(m.decode_errors));

        const uptimeSec = Math.floor(m.uptime_ms / 1000);
        const mm = String(Math.floor(uptimeSec / 60)).padStart(2, "0");
        const ss = String(uptimeSec % 60).padStart(2, "0");
        document.getElementById("uptime-pill").textContent = `uptime: ${mm}:${ss}`;
      }

      function updateWarps(m) {
        const rows = (m.warps || []).slice().sort((a, b) => a.warp_id - b.warp_id);
        const tbody = d3.select("#warp-rows");
        const tr = tbody.selectAll("tr").data(rows, (d) => d.warp_id);

        tr.exit().remove();

        const trEnter = tr.enter().append("tr");
        trEnter.append("td").attr("class", "mono").attr("data-k", "warp_id");
        trEnter.append("td").attr("class", "mono").attr("data-k", "subscribers");
        trEnter.append("td").attr("class", "mono").attr("data-k", "publishers");
        trEnter.append("td").attr("class", "mono").attr("data-k", "last_frame");
        trEnter.append("td").attr("class", "mono").attr("data-k", "last_epoch");
        trEnter.append("td").attr("class", "mono").attr("data-k", "last_ts");
        trEnter.append("td").attr("class", "mono").attr("data-k", "last_state_hash");
        trEnter.append("td").attr("class", "mono").attr("data-k", "snapshot_count");
        trEnter.append("td").attr("class", "mono").attr("data-k", "diff_count");

        const merged = trEnter.merge(tr);
        merged.select('[data-k="warp_id"]').text((d) => d.warp_id);
        merged.select('[data-k="subscribers"]').text((d) => d.subscribers);
        merged.select('[data-k="publishers"]').text((d) => d.publishers);
        merged.select('[data-k="last_frame"]').text((d) => d.last_frame || "—");
        merged.select('[data-k="last_epoch"]').text((d) => (d.last_epoch == null ? "—" : d.last_epoch));
        merged.select('[data-k="last_ts"]').text((d) => (d.last_ts == null ? "—" : d.last_ts));
        merged
          .select('[data-k="last_state_hash"]')
          .text((d) => (d.last_state_hash ? d.last_state_hash.slice(0, 16) + "…" : "—"));
        merged.select('[data-k="snapshot_count"]').text((d) => d.snapshot_count);
        merged.select('[data-k="diff_count"]').text((d) => d.diff_count);
      }

      function renderChart() {
        const container = d3.select("#chart");
        const w = Math.max(720, container.node().clientWidth || 720);
        const h = 220;
        const margin = { top: 10, right: 20, bottom: 24, left: 50 };
        const innerW = w - margin.left - margin.right;
        const innerH = h - margin.top - margin.bottom;

        container.selectAll("*").remove();
        const svg = container
          .append("svg")
          .attr("viewBox", `0 0 ${w} ${h}`)
          .attr("width", "100%")
          .attr("height", h);
        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear().domain([0, Math.max(1, history.length - 1)]).range([0, innerW]);
        const yMax = Math.max(1, d3.max(history, (d) => Math.max(d.wsFps, d.udsFps)) || 1);
        const y = d3.scaleLinear().domain([0, yMax * 1.1]).range([innerH, 0]).nice();

        g.append("g")
          .attr("stroke", getComputedStyle(document.documentElement).getPropertyValue("--grid") || "#213041")
          .attr("stroke-opacity", 0.5)
          .selectAll("line.h")
          .data(y.ticks(5))
          .join("line")
          .attr("x1", 0)
          .attr("x2", innerW)
          .attr("y1", (d) => y(d))
          .attr("y2", (d) => y(d));

        g.append("g").attr("transform", `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(6));
        g.append("g").call(d3.axisLeft(y).ticks(5));

        const line = (key) =>
          d3
            .line()
            .x((d, i) => x(i))
            .y((d) => y(d[key]));

        g.append("path")
          .datum(history)
          .attr("fill", "none")
          .attr("stroke", "#7aa2f7")
          .attr("stroke-width", 2)
          .attr("d", line("wsFps"));

        g.append("path")
          .datum(history)
          .attr("fill", "none")
          .attr("stroke", "#9ece6a")
          .attr("stroke-width", 2)
          .attr("d", line("udsFps"));

        // legend
        g.append("text")
          .attr("x", 6)
          .attr("y", 10)
          .attr("fill", "#7aa2f7")
          .attr("class", "mono")
          .style("font-size", "12px")
          .text("ws→uds fps");
        g.append("text")
          .attr("x", 120)
          .attr("y", 10)
          .attr("fill", "#9ece6a")
          .attr("class", "mono")
          .style("font-size", "12px")
          .text("uds→ws fps");
      }

      function pushSample(m) {
        const now = performance.now();
        const wsFrames = m.ws_to_uds.frames;
        const udsFrames = m.uds_to_ws.frames;

        if (!lastSample) {
          lastSample = { t: now, wsFrames, udsFrames };
          return;
        }

        const dt = Math.max(0.001, (now - lastSample.t) / 1000);
        const wsFps = (wsFrames - lastSample.wsFrames) / dt;
        const udsFps = (udsFrames - lastSample.udsFrames) / dt;
        lastSample = { t: now, wsFrames, udsFrames };

        history.push({ wsFps, udsFps });
        while (history.length > maxPoints) history.shift();
      }

      async function tick() {
        try {
          const m = await fetchMetrics();
          updateHeader(m);
          pushSample(m);
          updateWarps(m);
          renderChart();

          document.getElementById("status-pill").classList.remove("bad");
          document.getElementById("status-pill").classList.add("ok");
          document.getElementById("status-pill").textContent = "ok";
          setText("m-last-update", `last update: ${new Date().toLocaleTimeString()}`);
        } catch (err) {
          document.getElementById("status-pill").classList.remove("ok");
          document.getElementById("status-pill").classList.add("bad");
          document.getElementById("status-pill").textContent = "error";
          setText("m-last-update", `last update: error (${String(err)})`);
        } finally {
          setTimeout(tick, 1000);
        }
      }

      // Load D3 from the gateway so the dashboard works offline.
      (function () {
        const s = document.createElement("script");
        s.src = "/vendor/d3.v7.min.js";
        s.onload = () => tick();
        s.onerror = () => {
          document.getElementById("status-pill").classList.add("bad");
          document.getElementById("status-pill").textContent = "d3 load failed";
        };
        document.head.appendChild(s);
      })();
    </script>
  </body>
</html>

