# SPDX-License-Identifier: Apache-2.0
# © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots>
version: 1

# Crate classification drives path-aware CI gates
classes:
  DET_CRITICAL:
    description: "Determinism/security/replay-critical. Full gates required."
    required_gates: [G1, G2, G3, G4]
  DET_IMPORTANT:
    description: "Affects critical systems indirectly. Reduced gate set."
    # Note: required_gates defines policy-level merge blockers, not workflow
    # execution. G3 (perf regression) runs unconditionally for all non-NONCRITICAL
    # changes in det-gates.yml (run_none != 'true') but is not a merge blocker
    # for DET_IMPORTANT — consistent with RELEASE_POLICY.md staging-optional design.
    required_gates: [G2, G4]
  DET_NONCRITICAL:
    description: "No deterministic runtime impact. Standard CI only."
    required_gates: []

# One entry per workspace crate/package
crates:
  # ---- DET_CRITICAL ----
  warp-core:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/warp-core/**"]
  warp-geom:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/warp-geom/**"]
  warp-wasm:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/warp-wasm/**"]
  warp-ffi:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/warp-ffi/**"]
  echo-wasm-abi:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/echo-wasm-abi/**"]
  echo-scene-port:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/echo-scene-port/**"]
  echo-scene-codec:
    class: DET_CRITICAL
    owner_role: "Security Engineer"
    paths: ["crates/echo-scene-codec/**"]
  echo-graph:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/echo-graph/**"]
  echo-ttd:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/echo-ttd/**"]
  echo-dind-harness:
    class: DET_CRITICAL
    owner_role: "CI Engineer"
    paths: ["crates/echo-dind-harness/**"]
  echo-dind-tests:
    class: DET_CRITICAL
    owner_role: "CI Engineer"
    paths: ["crates/echo-dind-tests/**"]
  ttd-browser:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/ttd-browser/**"]
  ttd-protocol-rs:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/ttd-protocol-rs/**"]
  ttd-manifest:
    class: DET_CRITICAL
    owner_role: "Architect"
    paths: ["crates/ttd-manifest/**"]
  ci:
    class: DET_CRITICAL
    owner_role: "CI Engineer"
    # Intentional fail-safe: scripts/** is broadly classified as DET_CRITICAL
    # so new CI scripts are automatically covered. Utility scripts (docs-open.sh,
    # scaffold-community.sh, bench_*.py, etc.) pay the cost of extra CI runs but
    # cannot silently bypass gates. Per-script refinement tracked in #284.
    paths: [".github/workflows/**", "scripts/**", "det-policy.yaml", "Makefile", "xtask/**"]

  # ---- DET_IMPORTANT ----
  build-system:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["Cargo.toml", "Cargo.lock", "rust-toolchain.toml", "package.json", "pnpm-lock.yaml", "pnpm-workspace.yaml", "deny.toml", "audit.toml"]
  echo-wasm-bindings:
    class: DET_IMPORTANT
    owner_role: "Tooling Engineer"
    paths: ["crates/echo-wasm-bindings/**"]
  echo-wesley-gen:
    class: DET_IMPORTANT
    owner_role: "Tooling Engineer"
    paths: ["crates/echo-wesley-gen/**"]
  echo-app-core:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-app-core/**"]
  echo-cas:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-cas/**"]
  echo-config-fs:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-config-fs/**"]
  echo-registry-api:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-registry-api/**"]
  echo-session-client:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-session-client/**"]
  echo-session-proto:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-session-proto/**"]
  echo-session-service:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-session-service/**"]
  echo-session-ws-gateway:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/echo-session-ws-gateway/**"]
  warp-cli:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/warp-cli/**"]
  warp-viewer:
    class: DET_IMPORTANT
    owner_role: "Architect"
    paths: ["crates/warp-viewer/**"]
  warp-benches:
    class: DET_IMPORTANT
    owner_role: "Performance Engineer"
    paths: ["crates/warp-benches/**"]

  dind-tests-root:
    class: DET_IMPORTANT
    owner_role: "CI Engineer"
    paths: ["tests/dind*", "tests/hooks/**", "testdata/dind/**"]

  # ---- DET_NONCRITICAL ----
  # Catch-all: any file not matched by a higher-priority crate entry falls
  # through to DET_NONCRITICAL. classify_changes.cjs uses max-class semantics
  # (line 59), so a file matching both DET_CRITICAL and DET_NONCRITICAL is
  # always classified as DET_CRITICAL. This eliminates the need to enumerate
  # every top-level filename and prevents require_full_classification failures
  # when new non-critical files are added to the repo.
  ttd-app:
    class: DET_NONCRITICAL
    owner_role: "Frontend Engineer"
    paths: ["apps/ttd-app/**", "playwright.config.ts"]
  docs:
    class: DET_NONCRITICAL
    owner_role: "Tech Writer"
    paths: ["**"]
  echo-dry-tests:
    class: DET_NONCRITICAL
    owner_role: "CI Engineer"
    paths: ["crates/echo-dry-tests/**"]

policy:
  require_full_classification: true
  require_owners_for_critical: true
  deterministic_guardrails:
    enabled: true
    # Documentation-only; enforcement is in scripts/ban-nondeterminism.sh
    deny_patterns:
      - "HashMap"
      - "HashSet"
    allowlist_files: []
