<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->

# F10.1: Plugin ABI

A C-compatible plugin ABI enabling third-party extensions to hook into the Echo runtime without recompilation. Covers spec, host loader, version negotiation, capability tokens, and a reference plugin.

**Issues:** #26, #85, #86, #87, #88, #89
**Chain:** #85 → #86 → #87 → #88 → #89

## T-10-1-1: Draft C ABI Spec (#85)

**User Story:** As a plugin author, I want a clear C ABI specification so that I can write plugins in any language that targets C calling conventions.

**Requirements:**

- R1: Define the function signature contract (init, tick, shutdown hooks)
- R2: Define memory ownership rules (who allocates, who frees)
- R3: Define the vtable layout for host-provided callbacks
- R4: Specify alignment and padding guarantees for all struct types
- R5: Document ABI stability policy (semver rules for breaking changes)

**Acceptance Criteria:**

- [ ] AC1: Spec document exists at `docs/specs/SPEC-PLUGIN-ABI.md`
- [ ] AC2: Spec covers all five requirements above
- [ ] AC3: Spec includes at least one worked example (pseudocode or C)
- [ ] AC4: Spec reviewed by at least one other contributor

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Specification document only. No code.
**Out of Scope:** Implementation, version negotiation protocol, capability system.

**Test Plan:**

- **Goldens:** n/a (spec document)
- **Failures:** n/a
- **Edges:** n/a
- **Fuzz/Stress:** n/a

**Blocked By:** none
**Blocking:** T-10-1-2

**Est. Hours:** 4h
**Expected Complexity:** ~300 lines (markdown)

---

## T-10-1-2: C Header + Host Loader (#86)

**User Story:** As the Echo runtime, I want to dynamically load plugin shared libraries via a C ABI so that plugins can be developed and deployed independently.

**Requirements:**

- R1: Generate a `echo_plugin.h` C header from the spec
- R2: Implement `PluginLoader` in Rust that `dlopen`s a `.so`/`.dylib`/`.dll`
- R3: Resolve the required symbol table (init, tick, shutdown) with clear error messages on missing symbols
- R4: Loader must validate ABI magic number before calling any plugin function
- R5: Loader must be `#[cfg(not(target_arch = "wasm32"))]` — no WASM support yet

**Acceptance Criteria:**

- [ ] AC1: `echo_plugin.h` is generated or hand-written and checked in
- [ ] AC2: `PluginLoader::load(path)` returns `Result<PluginHandle, PluginError>`
- [ ] AC3: Missing-symbol and ABI-mismatch errors produce actionable diagnostics
- [ ] AC4: Unit tests cover successful load, missing symbol, and magic mismatch

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Header file, host-side loader, error types.
**Out of Scope:** Version negotiation, capability tokens, WASM target.

**Test Plan:**

- **Goldens:** Snapshot of generated `echo_plugin.h`
- **Failures:** Missing symbol, corrupt library, ABI magic mismatch
- **Edges:** Library with extra unexpected symbols (should still load)
- **Fuzz/Stress:** n/a

**Blocked By:** T-10-1-1
**Blocking:** T-10-1-3

**Est. Hours:** 6h
**Expected Complexity:** ~400 LoC

---

## T-10-1-3: Version Negotiation (#87)

**User Story:** As the Echo runtime, I want to negotiate ABI versions with plugins at load time so that incompatible plugins are rejected gracefully instead of causing undefined behavior.

**Requirements:**

- R1: Define a version negotiation handshake (host offers supported range, plugin declares its version)
- R2: Implement `negotiate_version()` call as part of the plugin init sequence
- R3: Support a compatibility matrix: exact match, minor-compatible, and rejected
- R4: Log negotiation result at `info` level

**Acceptance Criteria:**

- [ ] AC1: `PluginHandle` exposes `negotiated_version()` after successful load
- [ ] AC2: Incompatible version returns `PluginError::VersionMismatch` with both versions in the message
- [ ] AC3: Tests cover exact match, minor-compatible, and mismatch scenarios

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Version handshake protocol and implementation.
**Out of Scope:** Automatic plugin updates, capability negotiation.

**Test Plan:**

- **Goldens:** n/a
- **Failures:** Version mismatch (major), version mismatch (too old minor)
- **Edges:** Plugin at exact max supported version, plugin at min supported version
- **Fuzz/Stress:** n/a

**Blocked By:** T-10-1-2
**Blocking:** T-10-1-4

**Est. Hours:** 4h
**Expected Complexity:** ~200 LoC

---

## T-10-1-4: Capability Tokens (#88)

**User Story:** As a host operator, I want to grant plugins fine-grained capability tokens so that untrusted plugins cannot access resources they were not explicitly authorized for.

**Requirements:**

- R1: Define a `Capability` enum (e.g., `ReadState`, `WriteState`, `Network`, `FileSystem`)
- R2: Plugin init receives a `CapabilitySet` from the host
- R3: Host-side callbacks validate capability before executing
- R4: Capability violations return `PluginError::CapabilityDenied` (not a panic)
- R5: Capabilities are immutable after init — no runtime escalation

**Acceptance Criteria:**

- [ ] AC1: `CapabilitySet` type is defined and documented
- [ ] AC2: At least three capability variants exist
- [ ] AC3: Host callbacks check capabilities; denied access returns a typed error
- [ ] AC4: Tests cover granted access, denied access, and empty capability set

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Capability type, token validation in host callbacks.
**Out of Scope:** Persistent capability storage, capability delegation between plugins.

**Test Plan:**

- **Goldens:** n/a
- **Failures:** Capability denied for each variant, empty set denies all
- **Edges:** Plugin requesting capability not in the enum (forward-compat)
- **Fuzz/Stress:** n/a

**Blocked By:** T-10-1-3
**Blocking:** T-10-1-5

**Est. Hours:** 5h
**Expected Complexity:** ~300 LoC

---

## T-10-1-5: Example Plugin + Tests (#89)

**User Story:** As a plugin author, I want a reference plugin implementation with integration tests so that I have a concrete starting point for building my own plugins.

**Requirements:**

- R1: Write a trivial "echo" plugin in C that receives state, transforms it, and returns it
- R2: Plugin exercises init, tick, and shutdown hooks
- R3: Plugin uses at least one capability token
- R4: Integration test loads the plugin, runs a tick, and asserts the output
- R5: Include a `Makefile` or `build.rs` step to compile the example plugin

**Acceptance Criteria:**

- [ ] AC1: Example plugin compiles on CI (Linux + macOS)
- [ ] AC2: Integration test passes end-to-end (load → negotiate → tick → shutdown)
- [ ] AC3: Example plugin is documented with inline comments explaining each ABI hook
- [ ] AC4: README in `examples/plugin/` explains how to build and run

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Reference plugin, build script, integration tests, example README.
**Out of Scope:** Complex plugin logic, plugin registry, package distribution.

**Test Plan:**

- **Goldens:** Snapshot of plugin output for a known input state
- **Failures:** Plugin that panics in init, plugin that returns error from tick
- **Edges:** Plugin with no capabilities, plugin with all capabilities
- **Fuzz/Stress:** n/a

**Blocked By:** T-10-1-4
**Blocking:** none

**Est. Hours:** 6h
**Expected Complexity:** ~500 LoC (C + Rust + build glue)

---
