<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->

# F3.2: Schema Validators

Validation improvements for the knowledge graph schema. Enforce structural constraints on nodes and edges to catch invalid graph mutations early.

## T-3-2-1: Node and edge schema constraint validators

**User Story:** As a git-mind user, I want structural validation on my knowledge graph so that invalid nodes and edges are rejected before they corrupt the graph.

**Requirements:**

- R1: Define a schema constraint format (JSON) specifying required properties, property types, and allowed edge types per node kind.
- R2: Validate nodes against constraints on insert and update operations.
- R3: Validate edges against constraints: source/destination node kinds must be in the allowed set.
- R4: Validation errors include the constraint that was violated, the node/edge ID, and the offending value.
- R5: Schema constraints are stored in the git-mind repo (`.git-mind/schema.json`).

**Acceptance Criteria:**

- [ ] AC1: Inserting a node missing a required property produces a validation error.
- [ ] AC2: Creating an edge between disallowed node kinds produces a validation error.
- [ ] AC3: Updating a node property to an invalid type produces a validation error.
- [ ] AC4: Valid operations pass validation silently.
- [ ] AC5: Schema constraints file is loaded at startup and cached.

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Repo: git-mind. `schema/validator.js` module. Schema constraint format. Integration with node/edge CRUD operations.
**Out of Scope:** Schema migration between constraint versions. GraphQL schema generation from constraints. Async validation.

**Test Plan:**

- **Goldens:** Snapshot of validation error messages for 5+ violation scenarios.
- **Failures:** Missing schema file (graceful degradation or error), malformed schema JSON, circular kind references.
- **Edges:** Empty schema (all operations pass), maximally restrictive schema (most operations fail), schema with no edge constraints.
- **Fuzz/Stress:** Property test: random valid nodes always pass validation; random mutations to valid nodes produce either valid nodes or structured errors.

**Blocked By:** none
**Blocking:** T-3-3-1

**Est. Hours:** 6h
**Expected Complexity:** ~350 LoC

---

## T-3-2-2: Schema constraint CLI and introspection

**User Story:** As a git-mind user, I want CLI commands to inspect and manage schema constraints so that I can understand and evolve my graph's structural rules.

**Requirements:**

- R1: `git-mind schema show` prints the current schema constraints in a human-readable format.
- R2: `git-mind schema validate` runs a full graph validation against current constraints and reports all violations.
- R3: `git-mind schema init` creates a starter schema file with common defaults.
- R4: Validation summary includes counts: nodes checked, edges checked, violations found.

**Acceptance Criteria:**

- [ ] AC1: `schema show` outputs formatted constraint definitions.
- [ ] AC2: `schema validate` on a clean graph reports zero violations.
- [ ] AC3: `schema validate` on a graph with known violations reports all of them.
- [ ] AC4: `schema init` creates `.git-mind/schema.json` with a valid starter schema.

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Repo: git-mind. CLI commands (`show`, `validate`, `init`). Integration with T-3-2-1 validator.
**Out of Scope:** Schema diff between versions. Automated constraint inference from existing data.

**Test Plan:**

- **Goldens:** Snapshot of `schema show` output for a known schema. Snapshot of `schema validate` output with known violations.
- **Failures:** Running `schema show` with no schema file, `schema init` when file already exists.
- **Edges:** `schema validate` on empty graph, `schema validate` with empty schema.
- **Fuzz/Stress:** N/A.

**Blocked By:** T-3-2-1
**Blocking:** none

**Est. Hours:** 4h
**Expected Complexity:** ~200 LoC

---
