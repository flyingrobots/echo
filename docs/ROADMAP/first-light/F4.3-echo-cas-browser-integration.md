<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->

# F4.3: echo-cas Browser Integration

Validate and wire MemoryTier in the WASM context. echo-cas Phase 1 provides `MemoryTier` (in-memory, `HashMap`-backed). This feature confirms it compiles to WASM, exposes JS bindings for store/retrieve, and validates blob integrity in-browser.

## T-4-3-1: MemoryTier WASM compilation gate

**User Story:** As a developer, I want echo-cas to compile to `wasm32-unknown-unknown` so that the browser demo can use content-addressed storage.

**Requirements:**

- R1: `cargo build --target wasm32-unknown-unknown -p echo-cas` succeeds with no errors.
- R2: If `std` types (`HashMap`, `HashSet`) are problematic under WASM, add `cfg` gates or feature flags to substitute with `BTreeMap`/`BTreeSet`.
- R3: `blake3` dependency compiles to WASM (the `std` feature is already optional in blake3; verify `default-features = false` works).
- R4: CI job runs the WASM compilation check on every PR.

**Acceptance Criteria:**

- [ ] AC1: `cargo build --target wasm32-unknown-unknown -p echo-cas` exits 0 in CI.
- [ ] AC2: All existing echo-cas tests still pass on native (`cargo test -p echo-cas`).
- [ ] AC3: CI matrix includes the WASM target check.

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** WASM compilation verification, CI gate, any necessary `cfg` adjustments to echo-cas.
**Out of Scope:** JS bindings (T-4-3-2). Async API. DiskTier (MS-5).

**Test Plan:**

- **Goldens:** CI artifact: successful `wasm32-unknown-unknown` build log.
- **Failures:** Intentional breakage test: if someone adds a `std::fs` import, CI must fail.
- **Edges:** `blake3` with and without `std` feature. `thiserror` WASM compat (verify no `std::error::Error` issues on wasm32).
- **Fuzz/Stress:** N/A (compilation gate only).

**Blocked By:** none
**Blocking:** T-4-3-2

**Est. Hours:** 3h
**Expected Complexity:** ~30 LoC (Cargo.toml changes + CI config)

---

## T-4-3-2: JS bindings for CAS store/retrieve

**User Story:** As a web developer, I want to store and retrieve blobs from JavaScript so that the demo can persist simulation snapshots in content-addressed storage.

**Requirements:**

- R1: Expose `WasmBlobStore` class via wasm-bindgen wrapping a `MemoryTier`.
- R2: Methods: `put(bytes: Uint8Array) -> string` (returns hex hash), `get(hash_hex: string) -> Uint8Array | undefined`, `has(hash_hex: string) -> boolean`.
- R3: `put_verified(hash_hex: string, bytes: Uint8Array)` returns a result indicating success or hash mismatch.
- R4: Pin/unpin exposed as `pin(hash_hex)` / `unpin(hash_hex)`.

**Acceptance Criteria:**

- [ ] AC1: JS round-trip: `put(data)` returns hash H, `get(H)` returns identical bytes.
- [ ] AC2: `get` for a non-existent hash returns `undefined` (not an exception).
- [ ] AC3: `put_verified` with mismatched hash throws a structured error with `code: "HASH_MISMATCH"`.
- [ ] AC4: TypeScript type definitions (`.d.ts`) are generated by wasm-bindgen and type-check cleanly.

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** wasm-bindgen bindings for `BlobStore` trait methods. Hex hash string interface.
**Out of Scope:** Budget/eviction controls from JS. Batch put. Streaming put.

**Test Plan:**

- **Goldens:** Hash of `b"hello echo-cas"` matches the BLAKE3 reference vector (hex string comparison).
- **Failures:** `put_verified` mismatch. `get` with invalid hex string (odd length, non-hex chars).
- **Edges:** Empty blob (`b""`). 10MB blob. `put` same blob twice (idempotent, same hash, `len()` stays 1).
- **Fuzz/Stress:** Store 10,000 random blobs; retrieve all; verify integrity.

**Blocked By:** T-4-3-1
**Blocking:** none

**Est. Hours:** 4h
**Expected Complexity:** ~150 LoC (Rust wasm-bindgen + TypeScript tests)

---
