<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->

# F9.2: Worldline Convergence Suite (#187)

Replay-from-patches converges. Property tests showing that replaying from any checkpoint produces identical worldlines.

---

## T-9-2-1: Implement replay-from-checkpoint convergence tests

**User Story:** As a release engineer, I want property tests that prove replaying a simulation from any checkpoint produces identical state to the original run so that I can guarantee worldline convergence for time travel and debugging.

**Requirements:**

- R1: For a given simulation run, create checkpoints at ticks [0, N/4, N/2, 3N/4, N-1].
- R2: Replay from each checkpoint to the final tick; compare `state_root` and `commit_id` with the original run.
- R3: Replay from each checkpoint with the admission decision journal (not raw streams) to verify journal-based replay matches live execution.
- R4: Test with worldlines that include branch/fork points (from MS-7 TT2 operations).

**Acceptance Criteria:**

- [ ] AC1: Replay from all 5 checkpoint positions produces identical final state hash.
- [ ] AC2: Journal-based replay matches live-execution replay for all checkpoint positions.
- [ ] AC3: Replay from a fork point on a branched worldline produces identical state to the original branch execution.
- [ ] AC4: All tests pass on both macOS and Linux CI.

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Checkpoint replay convergence, journal replay, branched worldline replay.
**Out of Scope:** Replay performance optimization; distributed replay; replay from corrupted checkpoints.

**Test Plan:**

- **Goldens:** Final state hash from each replay path must match the original run's final hash.
- **Failures:** Checkpoint with missing tick patches (error, not silent divergence); journal with a gap (detected and reported).
- **Edges:** Replay from tick 0 (full replay); replay from the last tick (no simulation); replay from a tick just after a branch point.
- **Fuzz/Stress:** Property test: 20 random checkpoint positions in a 1000-tick simulation, all converge.

**Blocked By:** none
**Blocking:** T-9-2-2

**Est. Hours:** 5h
**Expected Complexity:** ~400 LoC

---

## T-9-2-2: Implement replay-from-patches convergence property tests

**User Story:** As a release engineer, I want property-based tests that replay from raw tick patches (not checkpoints) and prove convergence so that I can validate the tick patch format itself is sufficient for deterministic replay.

**Requirements:**

- R1: Given a simulation's tick patch stream, reconstruct state by applying patches sequentially from genesis.
- R2: Compare reconstructed `state_root` at every Kth tick (configurable, default K=10) with the original run.
- R3: Test with patches that include merge commits (multiple parents).
- R4: Verify that applying patches in the canonical order always produces the same result, regardless of the order they were received (for patches within the same tick, ordering is canonical).

**Acceptance Criteria:**

- [ ] AC1: Patch-based replay produces identical state at every sampled tick for a 500-tick simulation.
- [ ] AC2: Merge-commit patches produce identical post-merge state.
- [ ] AC3: Shuffling independent patches within a tick (if any) and re-applying produces the same result (ACI property).
- [ ] AC4: All tests pass on macOS, Ubuntu (glibc), and Alpine (musl).

**Definition of Done:**

- [ ] Code reviewed and merged
- [ ] Tests pass (CI green)
- [ ] Documentation updated (if applicable)

**Scope:** Patch-based replay, merge commit replay, ACI property verification, cross-OS CI.
**Out of Scope:** Patch compression; patch streaming over network; patch conflict resolution.

**Test Plan:**

- **Goldens:** Per-tick state hashes from patch replay must match original run hashes.
- **Failures:** Truncated patch stream (detected, reported at the missing tick); patch with invalid parent hash (rejected).
- **Edges:** Empty patch (no-op tick, state unchanged); patch that reverts a previous patch (state returns to earlier value).
- **Fuzz/Stress:** Property test: 100 random 200-tick simulations, patch replay converges on all.

**Blocked By:** T-9-2-1
**Blocking:** none

**Est. Hours:** 5h
**Expected Complexity:** ~350 LoC

---
