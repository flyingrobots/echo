<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Echo Benchmarks Dashboard</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #111822;
        --text: #e6edf3;
        --muted: #9fb1c1;
        --accent-a: #7aa2f7;
        --accent-b: #9ece6a;
        --grid: #213041;
        --warn: #f78c6c;
        --budget-60: #ff6b6b;
        --budget-1ms: #4ecdc4;
      }
      html, body { height: 100%; }
      body {
        margin: 0; padding: 24px; font-family: ui-sans-serif, system-ui, -apple-system,
        Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg); color: var(--text);
      }
      header { max-width: 1024px; margin: 0 auto 16px auto; }
      header h1 { margin: 0 0 8px 0; font-size: 24px; }
      header p { margin: 4px 0; color: var(--muted); }
      code { background: #0e1620; padding: 2px 6px; border-radius: 4px; }
      .panel { background: var(--panel); border-radius: 8px; padding: 16px; }
      .row { max-width: 1024px; margin: 0 auto; }
      #chart { height: 420px; }
      .chart-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
      .toggle-btn {
        background: var(--bg); border: 1px solid var(--grid); color: var(--muted);
        padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;
      }
      .toggle-btn.active { background: var(--accent-a); color: var(--bg); border-color: var(--accent-a); }
      .toggle-btn:hover { border-color: var(--accent-a); }
      .legend { display: flex; gap: 16px; align-items: center; color: var(--muted); flex-wrap: wrap; }
      .swatch { width: 12px; height: 12px; display: inline-block; border-radius: 3px; margin-right: 6px; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { text-align: left; padding: 6px 8px; border-bottom: 1px solid #1f2a36; }
      th { color: var(--muted); font-weight: 600; }
      .warn { color: var(--warn); }
      a { color: var(--accent-a); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .footer { color: var(--muted); font-size: 12px; margin-top: 12px; }
      .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px; }
      .stat-card { background: var(--bg); border-radius: 8px; padding: 16px; border-left: 4px solid; }
      .stat-card h3 { margin: 0 0 12px 0; font-size: 14px; font-weight: 600; }
      .stat-card table { margin-top: 0; }
      .threshold-marker { stroke: var(--warn); stroke-width: 2; stroke-dasharray: 8,4; opacity: 0.5; }
      .threshold-label { fill: var(--warn); font-size: 11px; }
      .budget-line { stroke-width: 1.5; stroke-dasharray: 4,4; }
      .budget-label { font-size: 10px; font-weight: 600; }
      #dynamic-stats { margin: 8px 0; padding: 12px; background: var(--bg); border-radius: 6px; }
      #dynamic-stats strong { color: var(--accent-b); }
      .callout { font-weight: 600; }
    </style>
  </head>
  <body>
    <header class="row">
      <h1>Echo Benchmarks</h1>
      <p><strong>What we're measuring:</strong> Deterministic scheduler overhead for executing <em>n</em> rewrites per transaction. Lower is better.</p>
      <div id="dynamic-stats">Loading benchmark data...</div>
      <p><strong>Why this matters:</strong> The scheduler maintains <strong>O(n)</strong> linear scaling through adaptive sorting—comparison sort for small batches, radix sort beyond n=1024.</p>
    </header>
    <main class="row panel">
      <div class="chart-controls">
        <button class="toggle-btn active" id="btn-budget" aria-pressed="true">Budget View</button>
        <button class="toggle-btn" id="btn-complexity" aria-pressed="false">Complexity View</button>
        <span class="legend" id="legend"></span>
      </div>
      <div id="chart"></div>
      <div id="tables"></div>
      <div id="missing" class="warn"></div>
    </main>

    <script>
      // Prefer locally vendored D3; fall back to CDN if missing.
      (function () {
        function load(src, ok, fail) {
          var s = document.createElement('script');
          s.src = src; s.onload = ok; s.onerror = fail; document.head.appendChild(s);
        }
        function start() { if (typeof d3 !== 'undefined') { window.__D3_READY__ = true; run(); } }
        // Try local vendor first
        load('vendor/d3.v7.min.js', start, function () {
          // Fallback to CDN as a last resort
          load('https://unpkg.com/d3@7', start, function () {
            document.getElementById('missing').textContent = 'Failed to load D3. Run `make vendor-d3` or `make bench-report`.';
          });
        });
      })();
    </script>
    <script>
      const GROUPS = [
        { key: 'snapshot_hash', label: 'Snapshot Hash', color: '#bb9af7', dash: null },          // purple
        { key: 'scheduler_drain', label: 'Scheduler Drain (Total)', color: '#9ece6a', dash: null }, // green
        { key: 'scheduler_drain/enqueue', label: 'Scheduler Enqueue', color: '#e0af68', dash: '4,4' }, // yellow
        { key: 'scheduler_drain/drain', label: 'Scheduler Drain Phase', color: '#f7768e', dash: '8,4' }, // red
      ];
      const INPUTS = [10, 100, 1000, 3000, 10000, 30000];
      const FRAME_BUDGET_NS = 16.67e6; // 60 FPS in nanoseconds
      const CHEAP_THRESHOLD_NS = 1e6;  // 1ms "this is cheap" line

      const params = new URLSearchParams(location.search);
      const ROOT = params.get('root') ?? '/';

      let currentView = 'budget'; // 'budget' or 'complexity'
      let cachedData = null;
      let cachedMissing = null;

      async function loadEstimate(group, n) {
        const basePath = `${ROOT}target/criterion/${group}/${n}`;
        const newPath = `${basePath}/new/estimates.json`;
        const baseAlt = `${basePath}/base/estimates.json`;
        try {
          const primary = await fetch(newPath);
          let res = primary;
          let path = newPath;
          if (!primary.ok) {
            const alt = await fetch(baseAlt);
            if (alt.ok) { res = alt; path = baseAlt; }
            else { throw new Error(`new: ${primary.status}; base: ${alt.status}`); }
          }
          const data = await res.json();
          const mean = (data.mean?.point_estimate ?? data.Mean?.point_estimate);
          const lb = (data.mean?.confidence_interval?.lower_bound ?? data.Mean?.confidence_interval?.lower_bound);
          const ub = (data.mean?.confidence_interval?.upper_bound ?? data.Mean?.confidence_interval?.upper_bound);
          if (typeof mean !== 'number') throw new Error('missing mean.point_estimate');
          return { ok: true, path, mean, lb, ub };
        } catch (err) {
          return { ok: false, path: newPath, error: String(err) };
        }
      }

      function fmtNs(ns) {
        if (ns < 1e3) return `${ns.toFixed(0)} ns`;
        if (ns < 1e6) return `${(ns/1e3).toFixed(2)} µs`;
        if (ns < 1e9) return `${(ns/1e6).toFixed(2)} ms`;
        return `${(ns/1e9).toFixed(2)} s`;
      }

      function fmtMs(ns) {
        return `${(ns / 1e6).toFixed(2)} ms`;
      }

      function updateDynamicStats(data) {
        const stats = document.getElementById('dynamic-stats');
        const scheduler1k = data.find(d => d.group === 'scheduler_drain' && d.n === 1000);
        const snapshot1k = data.find(d => d.group === 'snapshot_hash' && d.n === 1000);

        if (!scheduler1k) {
          stats.innerHTML = '<em>Benchmark data not available.</em>';
          return;
        }

        const schedulerMs = scheduler1k.mean / 1e6;
        const schedulerPct = ((scheduler1k.mean / FRAME_BUDGET_NS) * 100).toFixed(1);
        const schedulerCI = `${fmtMs(scheduler1k.lb ?? scheduler1k.mean)} – ${fmtMs(scheduler1k.ub ?? scheduler1k.mean)}`;

        let html = `<strong>At n=1000:</strong> Scheduler total is <strong>${fmtMs(scheduler1k.mean)}</strong> `;
        html += `(95% CI: ${schedulerCI}), ~<strong>${schedulerPct}%</strong> of a 60 FPS frame budget.`;

        if (snapshot1k) {
          const snapshotMs = snapshot1k.mean / 1e6;
          html += `<br>Snapshot hash: <strong>${fmtMs(snapshot1k.mean)}</strong>.`;
          const combined = scheduler1k.mean + snapshot1k.mean;
          const combinedPct = ((combined / FRAME_BUDGET_NS) * 100).toFixed(1);
          html += ` Combined tick overhead: ~<strong>${fmtMs(combined)}</strong> (${combinedPct}% of budget).`;
        }

        stats.innerHTML = html;
      }

      async function run() {
        if (Array.isArray(window.__CRITERION_DATA__)) {
          cachedData = window.__CRITERION_DATA__;
          cachedMissing = Array.isArray(window.__CRITERION_MISSING__) ? window.__CRITERION_MISSING__ : [];
        } else {
          cachedData = [];
          cachedMissing = [];
          for (const g of GROUPS) {
            for (const n of INPUTS) {
              const r = await loadEstimate(g.key, n);
              if (r.ok) cachedData.push({ group: g.key, n, mean: r.mean, lb: r.lb, ub: r.ub });
              else cachedMissing.push({ group: g.key, n, path: r.path, error: r.error });
            }
          }
        }

        updateDynamicStats(cachedData);
        render(cachedData, cachedMissing);

        // Wire up toggle buttons
        document.getElementById('btn-budget').addEventListener('click', () => setView('budget'));
        document.getElementById('btn-complexity').addEventListener('click', () => setView('complexity'));
      }

      function setView(view) {
        currentView = view;
        document.getElementById('btn-budget').classList.toggle('active', view === 'budget');
        document.getElementById('btn-complexity').classList.toggle('active', view === 'complexity');
        document.getElementById('btn-budget').setAttribute('aria-pressed', view === 'budget' ? 'true' : 'false');
        document.getElementById('btn-complexity').setAttribute('aria-pressed', view === 'complexity' ? 'true' : 'false');
        render(cachedData, cachedMissing);
      }

      function render(data, missing) {
        const container = d3.select('#chart');
        container.selectAll('*').remove();
        const width = Math.max(720, container.node().clientWidth || 720);
        const height = 420;
        const margin = { top: 20, right: 24, bottom: 40, left: 70 };
        const innerW = width - margin.left - margin.right;
        const innerH = height - margin.top - margin.bottom;

        const svg = container
          .append('svg')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .attr('width', '100%')
          .attr('height', height);

        const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

        const byGroup = d3.group(data, d => d.group);
        const allY = data.flatMap(d => [d.lb ?? d.mean, d.ub ?? d.mean]);
        const yMax = d3.max(allY) || 10;

        // X is always log scale
        const x = d3.scaleLog().domain([d3.min(INPUTS), d3.max(INPUTS)]).range([0, innerW]).nice();

        // Y depends on view mode
        let y, yAxisLabel;
        if (currentView === 'budget') {
          // Linear Y, ensure we show the 16.67ms budget line
          const yDomainMax = Math.max(yMax, FRAME_BUDGET_NS * 1.1);
          y = d3.scaleLinear().domain([0, yDomainMax]).range([innerH, 0]).nice();
          yAxisLabel = 'Time (ms)';
        } else {
          // Log Y for complexity view
          const yMin = d3.min(allY) || 1;
          y = d3.scaleLog().domain([Math.max(1, yMin * 0.5), yMax * 1.5]).range([innerH, 0]).nice();
          yAxisLabel = 'Time (log scale)';
        }

        const xAxis = d3.axisBottom(x).tickValues(INPUTS).tickFormat(d3.format('~s'));
        const yAxis = currentView === 'budget'
          ? d3.axisLeft(y).ticks(8).tickFormat(d => fmtMs(d))
          : d3.axisLeft(y).ticks(6, '~s').tickFormat(d => fmtNs(d));

        // Grid lines
        g.append('g')
          .attr('stroke', '#213041')
          .attr('stroke-opacity', 0.5)
          .selectAll('line.h')
          .data(y.ticks(8))
          .join('line')
          .attr('x1', 0)
          .attr('x2', innerW)
          .attr('y1', d => y(d))
          .attr('y2', d => y(d));

        // Budget lines (only in budget view)
        if (currentView === 'budget') {
          // 60 FPS budget line (16.67ms)
          const y60 = y(FRAME_BUDGET_NS);
          if (y60 >= 0 && y60 <= innerH) {
            g.append('line')
              .attr('class', 'budget-line')
              .attr('stroke', '#ff6b6b')
              .attr('x1', 0).attr('x2', innerW)
              .attr('y1', y60).attr('y2', y60);
            g.append('text')
              .attr('class', 'budget-label')
              .attr('fill', '#ff6b6b')
              .attr('x', innerW - 5)
              .attr('y', y60 - 5)
              .attr('text-anchor', 'end')
              .text('60 FPS budget (16.67ms)');
          }

          // 1ms "cheap" line
          const y1ms = y(CHEAP_THRESHOLD_NS);
          if (y1ms >= 0 && y1ms <= innerH) {
            g.append('line')
              .attr('class', 'budget-line')
              .attr('stroke', '#4ecdc4')
              .attr('x1', 0).attr('x2', innerW)
              .attr('y1', y1ms).attr('y2', y1ms);
            g.append('text')
              .attr('class', 'budget-label')
              .attr('fill', '#4ecdc4')
              .attr('x', innerW - 5)
              .attr('y', y1ms + 12)
              .attr('text-anchor', 'end')
              .text('1ms (cheap)');
          }
        }

        g.append('g').attr('transform', `translate(0,${innerH})`).call(xAxis).call(g=>g.selectAll('text').attr('fill', '#cbd6e2'));
        g.append('g').call(yAxis).call(g=>g.selectAll('text').attr('fill', '#cbd6e2'));

        // Axis labels
        g.append('text')
          .attr('text-anchor', 'middle')
          .attr('x', innerW / 2)
          .attr('y', innerH + 35)
          .attr('fill', '#cbd6e2')
          .style('font-size', '12px')
          .text('Input size (n)');

        g.append('text')
          .attr('text-anchor', 'middle')
          .attr('transform', `translate(-55,${innerH / 2})rotate(-90)`)
          .attr('fill', '#cbd6e2')
          .style('font-size', '12px')
          .text(yAxisLabel);

        // Radix sort threshold marker at n=1024
        const thresholdX = x(1024);
        g.append('line')
          .attr('class', 'threshold-marker')
          .attr('x1', thresholdX)
          .attr('x2', thresholdX)
          .attr('y1', 0)
          .attr('y2', innerH);
        g.append('text')
          .attr('class', 'threshold-label')
          .attr('x', thresholdX + 5)
          .attr('y', 15)
          .text('↓ radix sort');
        g.append('text')
          .attr('class', 'threshold-label')
          .attr('x', thresholdX - 5)
          .attr('y', 15)
          .attr('text-anchor', 'end')
          .text('comparison ↑');

        const line = d3.line()
          .x(d => x(d.n))
          .y(d => y(d.mean))
          .curve(d3.curveMonotoneX);

        for (const [group, series] of byGroup) {
          const groupInfo = GROUPS.find(g => g.key === group);
          const color = groupInfo?.color || '#7aa2f7';
          const dash = groupInfo?.dash;
          const sorted = series.slice().sort((a,b)=>a.n-b.n);

          const path = g.append('path')
            .datum(sorted)
            .attr('fill', 'none')
            .attr('stroke', color)
            .attr('stroke-width', 2)
            .attr('d', line);
          if (dash) path.attr('stroke-dasharray', dash);

          // CI band
          if (sorted.some(d => Number.isFinite(d.lb) && Number.isFinite(d.ub))) {
            const area = d3.area()
              .x(d => x(d.n))
              .y0(d => y(d.lb ?? d.mean))
              .y1(d => y(d.ub ?? d.mean))
              .curve(d3.curveMonotoneX);
            g.append('path')
              .datum(sorted)
              .attr('fill', color)
              .attr('opacity', 0.12)
              .attr('d', area);
          }

          // Points
          const safeClass = group.replace(/\//g, '-');
          g.selectAll(`circle.${safeClass}`)
            .data(sorted)
            .join('circle')
            .attr('class', safeClass)
            .attr('cx', d => x(d.n))
            .attr('cy', d => y(d.mean))
            .attr('r', 3.5)
            .attr('fill', color)
            .append('title')
            .text(d => `${groupInfo?.label || group} n=${d.n}\nmean: ${fmtNs(d.mean)}\nCI: ${fmtNs(d.lb ?? d.mean)}–${fmtNs(d.ub ?? d.mean)}`);

          // Callout at n=1000 for main groups
          if ((group === 'scheduler_drain' || group === 'snapshot_hash') && currentView === 'budget') {
            const pt1k = sorted.find(d => d.n === 1000);
            if (pt1k) {
              g.append('circle')
                .attr('cx', x(1000))
                .attr('cy', y(pt1k.mean))
                .attr('r', 7)
                .attr('fill', 'none')
                .attr('stroke', color)
                .attr('stroke-width', 2);
            }
          }
        }

        // Legend
        const legend = d3.select('#legend');
        legend.selectAll('*').remove();
        legend.selectAll('div.item')
          .data(GROUPS)
          .join('div')
          .attr('class', 'item')
          .html(d => {
            const dash = d.dash ? `stroke-dasharray="${d.dash}"` : '';
            return `<svg width="24" height="12" style="display:inline-block;vertical-align:middle;margin-right:6px"><line x1="0" y1="6" x2="24" y2="6" stroke="${d.color}" stroke-width="2" ${dash}/></svg>${d.label}`;
          });

        // Stat cards
        const tables = d3.select('#tables');
        tables.selectAll('*').remove();
        const grid = tables.append('div').attr('class', 'stats-grid');

        for (const ginfo of GROUPS) {
          const rows = data.filter(d => d.group === ginfo.key).sort((a,b)=>a.n-b.n);
          if (!rows.length) continue;

          const card = grid.append('div')
            .attr('class', 'stat-card')
            .style('border-left-color', ginfo.color);

          card.append('h3').text(ginfo.label).style('color', ginfo.color);

          const tbl = card.append('table');
          const thead = tbl.append('thead').append('tr');
          thead.html('<th>Input n</th><th>Mean</th><th>95% CI</th>');
          const tbody = tbl.append('tbody');
          tbody.selectAll('tr').data(rows).join('tr').html(d => {
            const ci = `${fmtNs(d.lb ?? d.mean)} – ${fmtNs(d.ub ?? d.mean)}`;
            const highlight = d.n === 1000 ? ' class="callout"' : '';
            return `<td${highlight}>${d.n}</td><td${highlight}>${fmtNs(d.mean)}</td><td${highlight}>${ci}</td>`;
          });
        }

        // Missing guidance
        const miss = d3.select('#missing');
        miss.selectAll('*').remove();
        if (missing.length) {
          miss.append('div').html(
            `Some results were not found. Ensure you:<br>` +
            `1) Serve repo root (e.g., run <code>make bench-serve</code>),<br>` +
            `2) Run <code>cargo bench -p warp-benches</code>,<br>` +
            `3) If serving elsewhere, pass <code>?root=../../</code>.`
          );
          const ul = miss.append('ul');
          ul.selectAll('li')
            .data(missing)
            .join('li')
            .text(m => `${m.group} n=${m.n} → ${m.path} (${m.error})`);
        }
      }

      // `run()` is invoked after D3 loads in the loader above.
    </script>
  </body>
</html>
