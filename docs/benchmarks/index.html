<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Echo Benchmarks Dashboard</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #111822;
        --text: #e6edf3;
        --muted: #9fb1c1;
        --accent-a: #7aa2f7;
        --accent-b: #9ece6a;
        --grid: #213041;
        --warn: #f78c6c;
      }
      html, body { height: 100%; }
      body {
        margin: 0; padding: 24px; font-family: ui-sans-serif, system-ui, -apple-system,
        Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg); color: var(--text);
      }
      header { max-width: 1024px; margin: 0 auto 16px auto; }
      header h1 { margin: 0 0 8px 0; font-size: 24px; }
      header p { margin: 4px 0; color: var(--muted); }
      code { background: #0e1620; padding: 2px 6px; border-radius: 4px; }
      .panel { background: var(--panel); border-radius: 8px; padding: 16px; }
      .row { max-width: 1024px; margin: 0 auto; }
      #chart { height: 420px; }
      .legend { display: flex; gap: 16px; align-items: center; margin: 8px 0 0 0; color: var(--muted); }
      .swatch { width: 12px; height: 12px; display: inline-block; border-radius: 3px; margin-right: 6px; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { text-align: left; padding: 6px 8px; border-bottom: 1px solid #1f2a36; }
      th { color: var(--muted); font-weight: 600; }
      .warn { color: var(--warn); }
      a { color: var(--accent-a); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .footer { color: var(--muted); font-size: 12px; margin-top: 12px; }
    </style>
  </head>
  <body>
    <header class="row">
      <h1>Echo Benchmarks</h1>
      <p>Visualizes Criterion results for <code>snapshot_hash</code> and <code>scheduler_drain</code> across inputs (10, 100, 1000).</p>
      <p>Run benches then serve this folder: <code>cargo bench -p rmg-benches</code>, then <code>python3 -m http.server 8000</code> and open <code>http://localhost:8000/docs/benchmarks/</code>.</p>
      <p class="footer">Tip: If your server root differs, pass a custom root via query (e.g., <code>?root=../../</code>). This page fetches <code>target/criterion/&lt;group&gt;/&lt;input&gt;/new/estimates.json</code>.</p>
    </header>
    <main class="row panel">
      <div id="chart"></div>
      <div class="legend" id="legend"></div>
      <div id="tables"></div>
      <div id="missing" class="warn"></div>
    </main>

    <script>
      // Prefer locally vendored D3; fall back to CDN if missing.
      (function () {
        function load(src, ok, fail) {
          var s = document.createElement('script');
          s.src = src; s.onload = ok; s.onerror = fail; document.head.appendChild(s);
        }
        function start() { if (typeof d3 !== 'undefined') { window.__D3_READY__ = true; run(); } }
        // Try local vendor first
        load('vendor/d3.v7.min.js', start, function () {
          // Fallback to CDN as a last resort
          load('https://unpkg.com/d3@7', start, function () {
            document.getElementById('missing').textContent = 'Failed to load D3. Run `make vendor-d3` or `make bench-report`.';
          });
        });
      })();
    </script>
    <script>
      const GROUPS = [
        { key: 'snapshot_hash', label: 'Snapshot Hash', color: getComputedStyle(document.documentElement).getPropertyValue('--accent-a').trim() || '#7aa2f7' },
        { key: 'scheduler_drain', label: 'Scheduler Drain', color: getComputedStyle(document.documentElement).getPropertyValue('--accent-b').trim() || '#9ece6a' },
      ];
      const INPUTS = [10, 100, 1000];
      const params = new URLSearchParams(location.search);
      const ROOT = params.get('root') ?? '../../';

      async function loadEstimate(group, n) {
        const path = `${ROOT}target/criterion/${group}/${n}/new/estimates.json`;
        try {
          const res = await fetch(path);
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const data = await res.json();
          // Criterion 0.5 uses lowercase keys like { mean: { point_estimate, confidence_interval: { lower_bound, upper_bound } } }
          const mean = (data.mean?.point_estimate ?? data.Mean?.point_estimate);
          const lb = (data.mean?.confidence_interval?.lower_bound ?? data.Mean?.confidence_interval?.lower_bound);
          const ub = (data.mean?.confidence_interval?.upper_bound ?? data.Mean?.confidence_interval?.upper_bound);
          if (typeof mean !== 'number') throw new Error('missing mean.point_estimate');
          return { ok: true, path, mean, lb, ub };
        } catch (err) {
          return { ok: false, path, error: String(err) };
        }
      }

      function fmtNs(ns) {
        if (ns < 1e3) return `${ns.toFixed(0)} ns`;
        if (ns < 1e6) return `${(ns/1e3).toFixed(2)} µs`;
        if (ns < 1e9) return `${(ns/1e6).toFixed(2)} ms`;
        return `${(ns/1e9).toFixed(2)} s`;
      }

      async function run() {
        const results = [];
        const missing = [];
        for (const g of GROUPS) {
          for (const n of INPUTS) {
            const r = await loadEstimate(g.key, n);
            if (r.ok) results.push({ group: g.key, n, mean: r.mean, lb: r.lb, ub: r.ub });
            else missing.push({ group: g.key, n, path: r.path, error: r.error });
          }
        }

        render(results, missing);
      }

      function render(data, missing) {
        const container = d3.select('#chart');
        container.selectAll('*').remove();
        const width = Math.max(720, container.node().clientWidth || 720);
        const height = 420;
        const margin = { top: 10, right: 24, bottom: 40, left: 60 };
        const innerW = width - margin.left - margin.right;
        const innerH = height - margin.top - margin.bottom;

        const svg = container
          .append('svg')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .attr('width', '100%')
          .attr('height', height);

        const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

        // Build series by group
        const byGroup = d3.group(data, d => d.group);
        const allY = data.flatMap(d => [d.lb ?? d.mean, d.ub ?? d.mean]);
        const yDomain = [d3.min(allY) || 1, d3.max(allY) || 10];

        // Log-scale X for inputs (10, 100, 1000)
        const x = d3.scaleLog().domain([d3.min(INPUTS), d3.max(INPUTS)]).range([0, innerW]).nice();
        const y = d3.scaleLog().domain([Math.max(1, yDomain[0]), yDomain[1]]).range([innerH, 0]).nice();

        const xAxis = d3.axisBottom(x).tickValues(INPUTS).tickFormat(d3.format('~s'));
        const yAxis = d3.axisLeft(y).ticks(6, '~s');

        // Grid
        g.append('g')
          .attr('stroke', getComputedStyle(document.documentElement).getPropertyValue('--grid') || '#213041')
          .attr('stroke-opacity', 0.5)
          .selectAll('line.h')
          .data(y.ticks(8))
          .join('line')
          .attr('x1', 0)
          .attr('x2', innerW)
          .attr('y1', d => y(d))
          .attr('y2', d => y(d));

        g.append('g').attr('transform', `translate(0,${innerH})`).call(xAxis).call(g=>g.selectAll('text').attr('fill', '#cbd6e2'));
        g.append('g').call(yAxis).call(g=>g.selectAll('text').attr('fill', '#cbd6e2'));

        const line = d3
          .line()
          .x(d => x(d.n))
          .y(d => y(d.mean))
          .curve(d3.curveMonotoneX);

        for (const [group, series] of byGroup) {
          const color = GROUPS.find(g => g.key === group)?.color || '#7aa2f7';
          const sorted = series.slice().sort((a,b)=>a.n-b.n);
          g.append('path')
            .datum(sorted)
            .attr('fill', 'none')
            .attr('stroke', color)
            .attr('stroke-width', 2)
            .attr('d', line);

          // CI band (if present)
          if (sorted.some(d => Number.isFinite(d.lb) && Number.isFinite(d.ub))) {
            const area = d3
              .area()
              .x(d => x(d.n))
              .y0(d => y(d.lb ?? d.mean))
              .y1(d => y(d.ub ?? d.mean))
              .curve(d3.curveMonotoneX);
            g.append('path')
              .datum(sorted)
              .attr('fill', color)
              .attr('opacity', 0.12)
              .attr('d', area);
          }

          // Points
          g.selectAll(`circle.${group}`)
            .data(sorted)
            .join('circle')
            .attr('class', group)
            .attr('cx', d => x(d.n))
            .attr('cy', d => y(d.mean))
            .attr('r', 3.5)
            .attr('fill', color)
            .append('title')
            .text(d => `${group} n=${d.n}\nmean: ${fmtNs(d.mean)}\nCI: ${fmtNs(d.lb ?? d.mean)}–${fmtNs(d.ub ?? d.mean)}`);
        }

        // Legend
        const legend = d3.select('#legend');
        legend.selectAll('*').remove();
        legend.selectAll('div.item')
          .data(GROUPS)
          .join('div')
          .attr('class', 'item')
          .html(d => `<span class="swatch" style="background:${d.color}"></span>${d.label}`);

        // Tables per group
        const tables = d3.select('#tables');
        tables.selectAll('*').remove();
        for (const ginfo of GROUPS) {
          const rows = data.filter(d => d.group === ginfo.key).sort((a,b)=>a.n-b.n);
          const section = tables.append('section').style('margin-top','16px');
          section.append('h3').text(ginfo.label).style('margin','8px 0');
          const tbl = section.append('table');
          const thead = tbl.append('thead').append('tr');
          thead.html('<th>Input n</th><th>Mean</th><th>95% CI</th>');
          const tbody = tbl.append('tbody');
          tbody.selectAll('tr').data(rows).join('tr').html(d => {
            const ci = `${fmtNs(d.lb ?? d.mean)} – ${fmtNs(d.ub ?? d.mean)}`;
            return `<td>${d.n}</td><td>${fmtNs(d.mean)}</td><td>${ci}</td>`;
          });
        }

        // Missing guidance
        const miss = d3.select('#missing');
        miss.selectAll('*').remove();
        if (missing.length) {
          miss.append('div').html(`Some results were not found. Run <code>cargo bench -p rmg-benches</code> first.`);
          const ul = miss.append('ul');
          ul.selectAll('li')
            .data(missing)
            .join('li')
            .text(m => `${m.group} n=${m.n} → ${m.path} (${m.error})`);
        }
      }

      // `run()` is invoked after D3 loads in the loader above.
    </script>
  </body>
  </html>
