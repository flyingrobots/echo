% SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0
% © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots>
\chapter{Deterministic Mathematics}

The cornerstone of Echo's reliability is its deterministic math module. Standard IEEE 754 floating-point arithmetic is famously non-deterministic across different architectures and compiler optimizations.

\section{The Hazards of Hardware Floats}

\begin{itemize}
    \item \textbf{NaN Payloads:} The bit pattern of `NaN` (Not a Number) is not fully specified. `0.0 / 0.0` might produce different bits on x86 vs ARM.
    \item \textbf{Signed Zero:} `-0.0` and `+0.0` compare equal but hash differently.
    \item \textbf{FMA (Fused Multiply-Add):} Some CPUs combine multiply and add into one step, changing rounding results.
    \item \textbf{Transcendental Functions:} `sin()`, `cos()`, `pow()` are often implemented in libc or hardware microcode, with varying precision.
\end{itemize}

\section{Echo's Current Float Wrapper: \texttt{F32Scalar}}

Echo wraps `f32` in a strict type, `F32Scalar`, with the policies implemented today:

\begin{enumerate}
    \item \textbf{Canonical Zero:} The constructor maps `-0.0` to `+0.0` (see Listing \ref{lst:f32scalar}).
    \item \textbf{NaN passthrough (for now):} NaNs are preserved as-is; canonical NaN collapsing is a planned follow-up.
    \item \textbf{Transcendentals:} `sin`/`cos` currently call `f32::sin`/`f32::cos`. Deterministic LUT or polynomial replacements are planned to remove platform variance.
\end{enumerate}

\begin{lstlisting}[language=Rust, caption=F32Scalar canonicalizes -0.0 and derives ordering, label=lst:f32scalar]
#[derive(Debug, Copy, Clone)]
pub struct F32Scalar {
    value: f32, // invariant: never stores -0.0
}

impl F32Scalar {
    pub const fn new(num: f32) -> Self {
        Self { value: num + 0.0 } // -0.0 -> +0.0
    }
}

impl Ord for F32Scalar {
    fn cmp(&self, other: &Self) -> Ordering {
        self.value.total_cmp(&other.value)
    }
}
\end{lstlisting}

\section{Geometric Types}

Built on top of `F32Scalar` are the standard geometric types:
\begin{itemize}
    \item \texttt{Vec2}, \texttt{Vec3}, \texttt{Vec4}
    \item \texttt{Mat3}, \texttt{Mat4} (Column-major)
    \item \texttt{Quat} (Quaternions for rotation)
\end{itemize}

These types ensure that vector operations (dot product, cross product, matrix multiplication) propagate determinism.

\section{Fixed Point Option}
For environments where floating-point hardware is completely unreliable or missing, Echo supports a `DFix64` (Deterministic Fixed Point) backend. This uses `i64` to represent decimal numbers (e.g., 32 bits for integer, 32 bits for fraction).
