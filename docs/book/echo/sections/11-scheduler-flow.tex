% SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0
% © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots>

\chapter{Deterministic Scheduler Flow}

\begin{figure}[htbp]
    \centering
\begin{tikzpicture}[node distance=1.8cm and 1.8cm, >=stealth, scale=0.85, every node/.style={transform shape}]
        \tikzstyle{lane}=[rectangle, rounded corners, draw, fill=gray!10, inner sep=6pt]
        \tikzstyle{sstep}=[rectangle, rounded corners, draw, fill=white, inner sep=6pt]
        \node[lane] (ingest) {Enqueue rules (scope, rule id)};
        \node[lane, right=2.2cm of ingest] (bucket) {Radix buckets (byte slices)};
        \node[lane, right=2.2cm of bucket] (drain) {Stable drain (bucket order)};
        \node[lane, right=2.2cm of drain] (conflict) {Footprint conflict check};
        \node[lane, right=2.2cm of conflict] (commit) {Apply + finalize tx};

        \draw[->, thick] (ingest) -- node[above]{order by (scope\_hash, rule\_id)} (bucket);
        \draw[->, thick] (bucket) -- node[above]{prefix sums} (drain);
        \draw[->, thick] (drain) -- node[above]{deterministic iterate} (conflict);
        \draw[->, thick] (conflict) -- node[above]{reserve / reject} (commit);

        \node[sstep, below=1.0cm of bucket] (legacy) {Legacy/BTree path};
        \draw[->, dashed] (ingest) -- (legacy);
        \draw[->, dashed] (legacy) -- (conflict);

        \node[sstep, below=1.0cm of drain] (telemetry) {Telemetry hooks};
        \draw[dashed] (drain) -- (telemetry);

        \node[sstep, above=0.9cm of conflict] (paradox) {Paradox guard hooks};
        \draw[dashed] (drain) -- (paradox);
    \end{tikzpicture}
    \caption[Radix scheduler flow]{Codex’s Baby (radix scheduler) keeps ordering stable via bucketed drains;\\ conflicts are resolved deterministically before commits.}
\end{figure}

Key invariants:
\begin{itemize}
    \item Ordering is stable: sorted by $(scope\_hash, rule\_id)$; radix buckets preserve order inside each byte slice.
    \item Footprint conflicts fail fast; no silent drops.
    \item Legacy/BTree path is optional for side-by-side comparisons.
    \item Telemetry and paradox guard hook in without altering order.
\end{itemize}
