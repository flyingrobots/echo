<!-- SPDX-License-Identifier: Apache-2.0 OR MIND-UCAL-1.0 -->
<!-- © James Ross Ω FLYING•ROBOTS <https://github.com/flyingrobots> -->

# Echo Schemas

This directory contains GraphQL schema definitions used by the Echo project.

## Files

| File                   | Purpose                                                                                            |
| ---------------------- | -------------------------------------------------------------------------------------------------- |
| `ttd-protocol.graphql` | TTD (Time-Travel Debugger) protocol schema - defines channels, events, state types, and operations |

## How Schemas Work

Schemas in this directory are the **source of truth** for protocol types. They are compiled by [Wesley](https://github.com/flyingrobots/Wesley) to generate:

- **Rust types** in `crates/ttd-protocol-rs/` (via `echo-ttd-gen`)
- **TypeScript types** in `packages/ttd-protocol-ts/`
- **JSON manifests** in `crates/ttd-manifest/`

## Workflow

### Regenerate After Schema Changes

After editing any schema file, regenerate all artifacts:

```bash
cargo xtask wesley sync
```

This command:

1. Runs Wesley's `compile-ttd` on the schema
2. Copies manifest files to `crates/ttd-manifest/`
3. Copies TypeScript files to `packages/ttd-protocol-ts/`
4. Generates Rust types via `echo-ttd-gen` to `crates/ttd-protocol-rs/`
5. Updates `docs/wesley/wesley.lock` with provenance info

### Verify Consistency

To verify that generated artifacts are up-to-date with the schema:

```bash
cargo xtask wesley check
```

CI runs this check automatically.

## Golden Rule

> **Never modify generated code. Modify the schema, then regenerate.**

Generated files contain a `SCHEMA_SHA256` (Rust) or `SCHEMA_HASH` (TypeScript) constant. If you see these in a file, it was generated by Wesley and should not be edited by hand.

## Schema Hash

Every generated artifact embeds the same `schema_hash`. This hash **must match** across all consumers:

- `ttd-protocol-rs` (Rust)
- `ttd-protocol-ts` (TypeScript)
- `ttd-browser` WASM module
- `ttd-manifest` JSON files
- `docs/wesley/wesley.lock`

If hashes diverge, run `cargo xtask wesley sync` to realign.
